<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* Sophisticated Midnight & Lavender Palette */
            --bg: #0f1021;
            --glass: rgba(25, 27, 49, 0.8);
            --glass-border: rgba(147, 132, 209, 0.2);
            --text: #e2e4f3;
            --muted: #8e94b9;
            
            /* Subdued Royal Accents */
            --royal-lavender: #9d8df1;
            --deep-plum: #5c4eb4;
            --royal-gradient: linear-gradient(135deg, #5c4eb4, #9d8df1);
            --btn-gradient: linear-gradient(135deg, #9d8df1 0%, #d8d2f5 100%);
            --accent-glow: rgba(157, 141, 241, 0.25);
            --success-indigo: #4e56b4;
            --danger-rose: #f43f5e;
            
            --card-shadow: 0 12px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .light {
            --bg: #f5f6fa;
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(92, 78, 180, 0.1);
            --text: #1e203d;
            --muted: #62668a;
            --card-shadow: 0 10px 25px -5px rgba(30, 32, 61, 0.08);
            --btn-gradient: linear-gradient(135deg, #5c4eb4 0%, #9d8df1 100%);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            background-image: 
                radial-gradient(at 0% 0%, rgba(92, 78, 180, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(157, 141, 241, 0.1) 0px, transparent 50%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .container { max-width: 1200px; margin: auto; padding: 40px 20px; }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
            position: relative;
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: var(--royal-lavender);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.6);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 { 
            font-weight: 800; font-size: 2.8rem; margin: 0; 
            letter-spacing: -1px;
            color: var(--text);
        }

        .xp-badge {
            background: var(--royal-gradient);
            color: #fff;
            padding: 8px 20px;
            border-radius: 100px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(92, 78, 180, 0.3);
        }

        button {
            padding: 12px 24px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            display: flex; align-items: center; gap: 10px;
            background: var(--glass);
            color: var(--text);
        }

        button:active { transform: scale(0.96); }

        .btn-primary { 
            background: var(--btn-gradient); 
            color: #0f1021 !important; 
            border: none;
            box-shadow: 0 4px 15px rgba(157, 141, 241, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--accent-glow);
            filter: brightness(1.05);
        }

        .btn-ghost:hover {
            background: var(--glass-border);
        }

        .active-view { 
            background: var(--royal-gradient) !important;
            color: white !important;
            border-color: transparent !important;
            box-shadow: 0 4px 12px rgba(92, 78, 180, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }

        .heatmap-container {
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--royal-lavender) transparent;
        }

        #heatmap {
            display: grid;
            grid-template-columns: repeat(53, 12px);
            gap: 4px;
            min-width: 850px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: rgba(147, 132, 209, 0.1);
            border-radius: 2px;
            position: relative;
        }
        .heatmap-cell.active { 
            background: var(--royal-lavender); 
            box-shadow: 0 0 8px var(--accent-glow);
        }
        .heatmap-cell:hover::after {
            content: attr(data-date);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            border: 1px solid var(--glass-border);
        }

        .checkbox-custom {
            width: 100%; height: 100%; 
            border: 2px solid var(--glass-border); 
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.03);
        }
        
        .checkbox-wrapper:hover .checkbox-custom { border-color: var(--royal-lavender); }

        .checkbox-wrapper input:checked + .checkbox-custom { 
            background: var(--royal-gradient); 
            border-color: transparent;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .checkbox-wrapper input:checked + .checkbox-custom::after {
            content: 'L';
            transform: scaleX(-1) rotate(-35deg);
            color: #fff;
            font-weight: 900;
            margin-bottom: 3px;
        }

        .stat-circle {
            width: 130px; height: 130px; border-radius: 50%;
            background: radial-gradient(circle, var(--bg) 64%, transparent 65%), 
                        conic-gradient(var(--royal-lavender) var(--progress), var(--glass-border) 0%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.6rem;
            flex-shrink: 0;
        }

        #habitInput {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px 20px;
            color: var(--text);
            width: 100%;
            max-width: 280px;
        }

        #habitInput:focus { outline: none; border-color: var(--royal-lavender); }

        .hidden { display: none !important; }
        
        table th { border-bottom: 1px solid var(--glass-border); }

        .cycle-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .cycle-card:hover {
            border-color: var(--royal-lavender);
            background: rgba(147, 132, 209, 0.05);
            transform: scale(1.05);
        }

        .cycle-card.current-week {
            border: 2px solid var(--royal-lavender) !important;
            background: rgba(157, 141, 241, 0.1) !important;
            box-shadow: 0 0 15px var(--accent-glow) !important;
        }

        .current-label {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--royal-gradient);
            color: white;
            font-size: 0.5rem;
            padding: 2px 5px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .percent-chip {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 20px;
            background: var(--glass-border);
            color: var(--royal-lavender);
            font-weight: 700;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div>
            <h1>ArohanPro</h1>
            <p id="dateDisplay" style="color: var(--muted); margin: 5px 0 0 0; font-weight: 400; font-size: 0.9rem; letter-spacing: 0.5px;">...</p>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
            <div class="xp-badge" id="xpDisplay">LVL 01 ‚Ä¢ 000 XP</div>
            <button class="btn-ghost" onclick="toggleDataModal()" style="padding: 10px">‚öôÔ∏è</button>
            <button class="btn-ghost" id="themeBtn" style="padding: 10px">üåô</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="glass-card" style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap; justify-content: center;">
            <div class="stat-circle" id="mainStatCircle" style="--progress: 0%;">
                <span id="mainStatText">0%</span>
                <span style="font-size: 0.6rem; color: var(--muted); letter-spacing: 1px; font-weight: 400;">TODAY</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="text-align: left;">
                    <h3 style="margin: 0; font-size: 1.1rem;">Performance</h3>
                    <p id="streakText" style="color: var(--royal-lavender); font-weight: 600; margin: 4px 0; font-size: 0.7rem; letter-spacing: 0.5px;">INITIALIZING...</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div style="background: rgba(147, 132, 209, 0.05); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 0.6rem; color: var(--muted); text-transform: uppercase;">Weekly</div>
                        <div id="weeklyStat" style="font-weight: 800; color: var(--text);">0%</div>
                    </div>
                    <div style="background: rgba(147, 132, 209, 0.05); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="font-size: 0.6rem; color: var(--muted); text-transform: uppercase;">Monthly</div>
                        <div id="monthlyStat" style="font-weight: 800; color: var(--text);">0%</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="glass-card" style="min-width: 0;">
            <h4 style="margin: 0 0 15px 0; font-weight: 600; color: var(--muted); font-size: 0.75rem; letter-spacing: 1px;">ACTIVITY ARCHIVE (PAST YEAR)</h4>
            <div class="heatmap-container">
                <div id="heatmap"></div>
            </div>
        </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px;">
        <div style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: 16px; border: 1px solid var(--glass-border); flex-wrap: wrap;">
            <button class="btn-ghost active-view" id="viewDash" style="padding: 8px 16px; font-size: 0.9rem;">Board</button>
            <button class="btn-ghost" id="viewWeek" style="padding: 8px 16px; font-size: 0.9rem;">Weekly</button>
            <button class="btn-ghost" id="viewMonth" style="padding: 8px 16px; font-size: 0.9rem;">Monthly</button>
        </div>
        <div style="display: flex; gap: 10px; flex-grow: 1; max-width: 400px; width: 100%;">
            <input id="habitInput" type="text" placeholder="Add new ritual...">
            <button class="btn-primary" id="addHabitBtn">Add ritual</button>
        </div>
    </div>

    <div id="dashboardView" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;"></div>

    <div id="weeklyView" class="hidden">
        <div class="glass-card">
            <h2 style="margin-top:0; font-size: 1.5rem;">Weekly Cycles</h2>
            <div id="weekly52Grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 12px;"></div>
        </div>
        <div id="selectedWeekDetail" class="glass-card hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h3 id="weekTitle" style="color: var(--royal-lavender); margin: 0;">Week Detail</h3>
                    <span id="weekDetailPercent" class="percent-chip">0% Score</span>
                </div>
                <button class="btn-ghost" onclick="closeWeekDetail()" style="padding: 5px 12px;">√ó</button>
            </div>
            <div style="overflow-x: auto; margin-top: 20px;">
                <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
                    <thead id="weekHead"></thead>
                    <tbody id="weekBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="monthView" class="glass-card hidden">
        <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 24px; flex-wrap: wrap;">
            <button class="btn-ghost" id="prevMonth">‚Üê</button>
            <div style="text-align: center;">
                <h2 id="monthLabel" style="margin:0; font-size: 1.4rem;">...</h2>
                <span id="monthDetailPercent" class="percent-chip" style="margin-top: 4px; display: inline-block;">0% Score</span>
            </div>
            <button class="btn-ghost" id="nextMonth">‚Üí</button>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead id="monthHead"></thead>
                <tbody id="monthBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="dataModal" class="hidden" style="position: fixed; inset: 0; background: rgba(15, 16, 33, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px);">
    <div class="glass-card" style="width: 380px; text-align: center;">
        <h3 style="margin-bottom: 25px;">Settings</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn-primary" onclick="exportData()" style="justify-content: center;">Export Data</button>
            <label class="btn-ghost" style="justify-content: center; cursor: pointer;">
                Import Data
                <input type="file" id="importInput" style="display:none" onchange="importData(event)">
            </label>
            <button class="btn-ghost" onclick="toggleDataModal()" style="margin-top: 10px; justify-content: center; color: var(--danger-rose);">Close</button>
        </div>
    </div>
</div>

<script>
    let habitData = JSON.parse(localStorage.getItem('arohan_v5_data')) || {};
    let xp = parseInt(localStorage.getItem('arohan_v5_xp')) || 0;
    let currentTheme = localStorage.getItem('arohan_v5_theme') || 'dark';
    let viewDate = new Date();
    let currentView = 'dashboard'; 

    function save() {
        localStorage.setItem('arohan_v5_data', JSON.stringify(habitData));
        localStorage.setItem('arohan_v5_xp', xp.toString());
    }

    function initMonthData(key) {
        if (!habitData[key]) {
            const keys = Object.keys(habitData).sort();
            const lastKey = keys[keys.length - 1];
            const baseHabits = lastKey ? habitData[lastKey].map(h => h.name) : ["Morning Review", "Core Work", "Exercise", "Reading"];
            const [year, month] = key.split('-').map(Number);
            habitData[key] = baseHabits.map(name => ({ name, days: Array(new Date(year, month + 1, 0).getDate()).fill(false) }));
        }
    }

    // Precise Week Number Calculation
    function getCurrentWeekNumber() {
        const today = new Date();
        const year = today.getFullYear();
        const startOfYear = new Date(year, 0, 1);
        
        // Find the day of the year (1-366)
        const diff = today - startOfYear;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay) + 1;
        
        // ISO-like week calculation
        // Weeks start on Sunday (0) or Monday (1)
        // Here we align 7-day blocks starting from the very first day of the year
        return Math.ceil(dayOfYear / 7);
    }

    function render() {
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        updateXP();
        updateStats();
        renderHeatmap();

        const views = { dashboard: 'dashboardView', weekly: 'weeklyView', monthly: 'monthView' };
        Object.keys(views).forEach(v => document.getElementById(views[v]).classList.toggle('hidden', currentView !== v));
        
        ['viewDash', 'viewWeek', 'viewMonth'].forEach((id, idx) => {
            const v = ['dashboard', 'weekly', 'monthly'][idx];
            document.getElementById(id).classList.toggle('active-view', currentView === v);
        });

        if (currentView === 'dashboard') renderDashboard();
        if (currentView === 'weekly') renderWeekly52();
        if (currentView === 'monthly') renderMonthlyView();
    }

    function updateXP() {
        const level = Math.floor(xp / 100) + 1;
        document.getElementById('xpDisplay').textContent = `LVL ${level} ‚Ä¢ ${xp % 100} XP`;
    }

    function updateStats() {
        const today = new Date();
        const key = `${today.getFullYear()}-${today.getMonth()}`;
        initMonthData(key);
        const habits = habitData[key];
        const dayIdx = today.getDate() - 1;
        
        const completedToday = habits.filter(h => h.days[dayIdx]).length;
        const percentToday = habits.length > 0 ? Math.round((completedToday / habits.length) * 100) : 0;
        document.getElementById('mainStatCircle').style.setProperty('--progress', percentToday + '%');
        document.getElementById('mainStatText').textContent = percentToday + '%';
        document.getElementById('streakText').textContent = percentToday > 60 ? 'FLOW STATE' : 'BUILDING MOMENTUM';

        const dayOfWeek = today.getDay();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - dayOfWeek);
        let totalWeekSlots = 0;
        let completedWeekSlots = 0;

        for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            const dKey = `${d.getFullYear()}-${d.getMonth()}`;
            const dIdx = d.getDate() - 1;
            if (habitData[dKey]) {
                habitData[dKey].forEach(h => {
                    totalWeekSlots++;
                    if (h.days[dIdx]) completedWeekSlots++;
                });
            }
        }
        const weeklyPercent = totalWeekSlots > 0 ? Math.round((completedWeekSlots / totalWeekSlots) * 100) : 0;
        document.getElementById('weeklyStat').textContent = weeklyPercent + '%';

        let totalMonthSlots = 0;
        let completedMonthSlots = 0;
        habits.forEach(h => {
            h.days.forEach(day => {
                totalMonthSlots++;
                if (day) completedMonthSlots++;
            });
        });
        const monthlyPercent = totalMonthSlots > 0 ? Math.round((completedMonthSlots / totalMonthSlots) * 100) : 0;
        document.getElementById('monthlyStat').textContent = monthlyPercent + '%';
    }

    function renderDashboard() {
        const container = document.getElementById('dashboardView');
        const today = new Date();
        const key = `${today.getFullYear()}-${today.getMonth()}`;
        initMonthData(key);
        const dayIdx = today.getDate() - 1;

        container.innerHTML = habitData[key].map((h, hIdx) => `
            <div class="glass-card" style="display:flex; justify-content:space-between; align-items:center; padding: 20px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <span style="font-weight:600; font-size:1.05rem;">${h.name}</span>
                    <span style="color:var(--muted); font-size:0.7rem; letter-spacing:0.5px; text-transform:uppercase;">Daily Goal</span>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <label class="checkbox-wrapper" style="width:44px; height:44px; cursor:pointer;">
                        <input type="checkbox" style="display:none" ${h.days[dayIdx] ? 'checked' : ''} onchange="toggleHabit('${key}', ${hIdx}, ${dayIdx}, true)">
                        <div class="checkbox-custom"></div>
                    </label>
                    <button onclick="deleteHabit(${hIdx})" style="color:var(--danger-rose); background:transparent; border:none; padding:5px; font-size:1.2rem; opacity:0.4;">√ó</button>
                </div>
            </div>
        `).join('');
    }

    function renderWeekly52() {
        const grid = document.getElementById('weekly52Grid');
        grid.innerHTML = '';
        const currentWeekNum = getCurrentWeekNumber();

        for (let i = 1; i <= 52; i++) {
            const isCurrent = (i === currentWeekNum);
            const box = document.createElement('div');
            // Force re-evaluation of current-week class
            box.className = `cycle-card ${isCurrent ? 'current-week' : ''}`;
            box.innerHTML = `
                ${isCurrent ? '<div class="current-label">Now</div>' : ''}
                <span style="font-size: 0.6rem; color: var(--muted);">W</span><br>
                <b>${i}</b>
            `;
            box.onclick = () => showWeekDetail(i);
            grid.appendChild(box);
        }
    }

    function showWeekDetail(weekNum) {
        const detail = document.getElementById('selectedWeekDetail');
        detail.classList.remove('hidden');
        document.getElementById('weekTitle').textContent = `Cycle ${weekNum}`;
        const currentYear = new Date().getFullYear();
        const startOfYear = new Date(currentYear, 0, 1);
        
        // Calculate the start day of the week
        const weekStart = new Date(startOfYear);
        weekStart.setDate(startOfYear.getDate() + (weekNum - 1) * 7);
        
        let totalSlots = 0;
        let completedSlots = 0;

        let head = '<tr><th style="text-align:left; padding:12px; color:var(--muted); font-size:0.75rem;">HABIT</th>';
        for(let i=0; i<7; i++) {
            const d = new Date(weekStart); d.setDate(weekStart.getDate() + i);
            head += `<th style="text-align:center; padding:12px; color:var(--muted); font-size:0.75rem;">${d.getDate()}</th>`;
        }
        document.getElementById('weekHead').innerHTML = head + '</tr>';
        
        // Note: For multi-month weeks, we'd need more complex logic, but this covers basic rendering
        const key = `${weekStart.getFullYear()}-${weekStart.getMonth()}`;
        initMonthData(key);

        document.getElementById('weekBody').innerHTML = (habitData[key] || []).map((h, hIdx) => `
            <tr>
                <td style="padding:12px; border-top:1px solid var(--glass-border); font-size:0.9rem;">${h.name}</td>
                ${[0,1,2,3,4,5,6].map(o => {
                    const d = new Date(weekStart); d.setDate(weekStart.getDate() + o);
                    const dk = `${d.getFullYear()}-${d.getMonth()}`;
                    const di = d.getDate() - 1;
                    
                    // Safe check for data existence
                    if(!habitData[dk]) initMonthData(dk);
                    const ch = habitData[dk] && habitData[dk][hIdx] && habitData[dk][hIdx].days[di];
                    
                    totalSlots++;
                    if (ch) completedSlots++;

                    return `<td style="text-align:center; border-top:1px solid var(--glass-border); padding:10px;">
                        <input type="checkbox" ${ch?'checked':''} onchange="toggleHabit('${dk}', ${hIdx}, ${di})" style="width:16px; height:16px; accent-color:var(--royal-lavender);">
                    </td>`;
                }).join('')}
            </tr>`).join('');

        const score = totalSlots > 0 ? Math.round((completedSlots / totalSlots) * 100) : 0;
        document.getElementById('weekDetailPercent').textContent = `${score}% Score`;
        setTimeout(() => detail.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
    }

    function renderMonthlyView() {
        const key = `${viewDate.getFullYear()}-${viewDate.getMonth()}`;
        initMonthData(key);
        document.getElementById('monthLabel').textContent = `${viewDate.toLocaleString('default', { month: 'long' })} ${viewDate.getFullYear()}`;
        const habits = habitData[key];
        
        let totalSlots = 0;
        let completedSlots = 0;

        let head = '<tr><th style="text-align:left; padding:12px; color:var(--muted); font-size:0.75rem;">HABIT</th>';
        for(let i=1; i<=habits[0].days.length; i++) head += `<th style="text-align:center; padding:4px; font-size:0.6rem;">${i}</th>`;
        document.getElementById('monthHead').innerHTML = head + '</tr>';
        document.getElementById('monthBody').innerHTML = habits.map((h, hIdx) => `
            <tr>
                <td style="padding:12px; border-top:1px solid var(--glass-border); font-size:0.85rem;">${h.name}</td>
                ${h.days.map((c, dIdx) => {
                    totalSlots++;
                    if (c) completedSlots++;
                    return `<td style="text-align:center; border-top:1px solid var(--glass-border); padding:2px;"><input type="checkbox" ${c?'checked':''} onchange="toggleHabit('${key}', ${hIdx}, ${dIdx})" style="accent-color:var(--royal-lavender);"></td>`;
                }).join('')}
            </tr>`).join('');

        const score = totalSlots > 0 ? Math.round((completedSlots / totalSlots) * 100) : 0;
        document.getElementById('monthDetailPercent').textContent = `${score}% Score`;
    }

    function renderHeatmap() {
        const container = document.getElementById('heatmap');
        container.innerHTML = '';
        const now = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setDate(now.getDate() - 364);

        for(let i=0; i<371; i++) {
            const date = new Date(oneYearAgo);
            date.setDate(date.getDate() + i);
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            cell.setAttribute('data-date', date.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'}));
            const key = `${date.getFullYear()}-${date.getMonth()}`;
            const dayIdx = date.getDate() - 1;
            if (habitData[key]) {
                const totalHabits = habitData[key].length;
                const completedCount = habitData[key].filter(h => h.days[dayIdx]).length;
                if (completedCount > 0) {
                    cell.classList.add('active');
                    cell.style.opacity = 0.3 + (completedCount / totalHabits) * 0.7;
                }
            }
            container.appendChild(cell);
        }
    }

    window.toggleHabit = (key, hIdx, dIdx, isMain) => {
        initMonthData(key);
        if (!habitData[key] || !habitData[key][hIdx]) return;
        const checked = !habitData[key][hIdx].days[dIdx];
        habitData[key][hIdx].days[dIdx] = checked;
        if (checked) {
            xp += 10;
            if (isMain) confetti({ particleCount: 60, spread: 60, origin: { y: 0.8 }, colors: ['#9d8df1', '#5c4eb4', '#ffffff'] });
        } else xp = Math.max(0, xp - 5);
        save(); render();
    };

    window.deleteHabit = (idx) => {
        const key = `${viewDate.getFullYear()}-${viewDate.getMonth()}`;
        habitData[key].splice(idx, 1);
        save(); render();
    };

    document.getElementById('addHabitBtn').onclick = () => {
        const input = document.getElementById('habitInput');
        const name = input.value.trim();
        if (!name) return;
        const key = `${viewDate.getFullYear()}-${viewDate.getMonth()}`;
        initMonthData(key);
        habitData[key].push({ name, days: Array(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate()).fill(false) });
        input.value = ''; save(); render();
    };

    document.getElementById('viewDash').onclick = () => { currentView = 'dashboard'; render(); };
    document.getElementById('viewWeek').onclick = () => { currentView = 'weekly'; render(); };
    document.getElementById('viewMonth').onclick = () => { currentView = 'monthly'; render(); };
    document.getElementById('prevMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); render(); };
    document.getElementById('nextMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); render(); };
    
    document.getElementById('themeBtn').onclick = () => {
        currentTheme = document.body.classList.contains('light') ? 'dark' : 'light';
        document.body.classList.toggle('light', currentTheme === 'light');
        document.getElementById('themeBtn').textContent = currentTheme === 'light' ? 'üåû' : 'üåô';
        localStorage.setItem('arohan_v5_theme', currentTheme);
    };

    window.toggleDataModal = () => document.getElementById('dataModal').classList.toggle('hidden');
    window.closeWeekDetail = () => document.getElementById('selectedWeekDetail').classList.add('hidden');

    function exportData() {
        const blob = new Blob([JSON.stringify({ data: habitData, xp })], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `arohan-pro-backup.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imp = JSON.parse(ev.target.result);
                habitData = imp.data; xp = imp.xp;
                save(); render(); toggleDataModal();
            } catch(e) { alert("Format Error"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    if (currentTheme === 'light') document.body.classList.add('light');
    render();
</script>
</body>
</html>
